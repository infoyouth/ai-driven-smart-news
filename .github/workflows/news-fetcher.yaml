name: AI Driven News ğŸš€

on:
  workflow_dispatch: # Allow manual triggering of the workflow
  schedule: # Run the workflow on a schedule
    - cron: "0 3 * * *" # Runs daily at 3 AM UTC

  #pull_request: # Trigger on pull request events
  #  branches:
  #    - main

jobs:
  run_main_script:
    runs-on: ubuntu-24.04
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }} # Set the API key from GitHub Secrets
      NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }} # Set the NewsAPI key from GitHub Secrets
    steps:
      - name: ğŸš— Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Set Up Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: ğŸ—„ï¸ Cache Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-poetry-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-poetry-

      - name: ğŸ“¦ Install Poetry
        run: |
          echo "ğŸ”„ Installing Poetry..."
          python -m pip install --upgrade pip
          pip install poetry

      - name: ğŸ“¦ Install Dependencies and Project
        run: |
          echo "ğŸ”„ Installing dependencies and project..."
          poetry install

      - name: ğŸ§ª Debug Python Environment
        run: |
          echo "Python executable: $(which python)"
          echo "Python version: $(python --version)"
          echo "Installed packages:"
          python -m pip list

      - name: ğŸ§ª Set PYTHONPATH
        run: |
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          echo "PYTHONPATH set to: $PYTHONPATH"

      - name: ğŸ“ Run Main Script
        run: |
          set -e
          echo "ğŸš€ Running main.py within Poetry environment..."
          poetry run python main.py
          #echo "ğŸ’° [Walmart & Amazon Exploring Stablecoins](https://www.wsj.com/finance/banking/walmart-amazon-stablecoin-07de2fdd)" > output.txt

      - name: âœ… Validate Output Files
        id: validate-output
        run: |
          # Ensure at least one filtered file exists
          set -e
          SH_FILES=$(ls filtered_*.json 2>/dev/null || true)
          if [ -z "$SH_FILES" ]; then
            echo "no_filtered_files=true" >> $GITHUB_ENV
            echo "No filtered files found. Exiting with error." >&2
            exit 1
          else
            echo "no_filtered_files=false" >> $GITHUB_ENV
          fi

      - name: ğŸ” Read filtered_newsapi.json into step output
        id: read_newsapi
        if: ${{ env.no_filtered_files == 'false' }}
        shell: bash
        run: |
          set -euo pipefail
          file=filtered_newsapi.json
          if [ -f "$file" ] && [ -s "$file" ]; then
            DELIM="END_NEWSAPI_$(uuidgen)"
            echo "content<<${DELIM}" >> $GITHUB_OUTPUT
            cat "$file" >> $GITHUB_OUTPUT
            echo "${DELIM}" >> $GITHUB_OUTPUT
            echo "Read $file into step output"
          else
            echo "No $file to read"
          fi

      - name: ğŸ“¢ Notify Discord â€” NewsAPI
        if: ${{ steps.read_newsapi.outputs.content != '' }}
        uses: cabrera-evil/discord-notify-action@v1.0.1
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "AI-Driven Breaking News â€” NewsAPI"
          description: ${{ steps.read_newsapi.outputs.content }}
          include_image: 'true'
          username: 'Youth Innovations'
          custom_image_url: 'https://raw.githubusercontent.com/infoyouth/infoyouth.github.io/main/configs/image/favicon-48x48.png'

      - name: ï¿½ Read filtered_hackernews.json into step output
        id: read_hackernews
        if: ${{ env.no_filtered_files == 'false' }}
        shell: bash
        run: |
          set -euo pipefail
          file=filtered_hackernews.json
          if [ -f "$file" ] && [ -s "$file" ]; then
            DELIM="END_HACKERNEWS_$(uuidgen)"
            echo "content<<${DELIM}" >> $GITHUB_OUTPUT
            cat "$file" >> $GITHUB_OUTPUT
            echo "${DELIM}" >> $GITHUB_OUTPUT
            echo "Read $file into step output"
          else
            echo "No $file to read"
          fi

      - name: ğŸ“¢ Notify Discord â€” HackerNews
        if: ${{ steps.read_hackernews.outputs.content != '' }}
        uses: cabrera-evil/discord-notify-action@v1.0.1
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "AI-Driven Breaking News â€” HackerNews"
          description: ${{ steps.read_hackernews.outputs.content }}
          include_image: 'true'
          username: 'Youth Innovations'
          custom_image_url: 'https://raw.githubusercontent.com/infoyouth/infoyouth.github.io/main/configs/image/favicon-48x48.png'
      - name: ğŸŒ Beautify Logs
        run: echo "ğŸ‰ Workflow completed successfully! ğŸ‰"
